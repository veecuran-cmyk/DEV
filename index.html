<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev
        
    </title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-color: #282c34;
            --taskbar-bg: rgba(20, 22, 26, 0.85);
            --window-bg: rgba(33, 37, 43, 0.95);
            --text-color: #abb2bf;
            --primary-color: #61afef;
            --accent-color: #98c379;
            --danger-color: #e06c75;
            --font-ui: 'Segoe UI', system-ui, sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            --glass-blur: blur(15px);
            --shadow-win: 0 15px 50px rgba(0,0,0,0.7);
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; outline: none; user-select: none; }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            font-family: var(--font-ui); color: var(--text-color);
        }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4b5263; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #5c6370; }

        /* --- BOOT SCREEN --- */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: var(--font-code); color: var(--primary-color);
        }
        .loader-bar {
            width: 300px; height: 4px; background: #333; margin-top: 20px;
            border-radius: 2px; overflow: hidden;
        }
        .loader-progress {
            width: 0%; height: 100%; background: var(--primary-color); transition: width 0.1s;
        }

        /* --- DESKTOP ENVIRONMENT --- */
        #desktop {
            position: absolute; top: 0; left: 0; width: 100%; height: calc(100vh - 45px);
            background: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072') no-repeat center center/cover;
            background-size: cover; overflow: hidden;
        }

        /* ICONS */
        .desktop-icons-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
        .icon {
            position: absolute; width: 90px; padding: 10px 5px;
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; border: 1px solid transparent; border-radius: 6px;
            color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.9);
            transition: background 0.2s;
        }
        .icon:hover { background-color: rgba(255, 255, 255, 0.1); }
        .icon.selected {
            background-color: rgba(97, 175, 239, 0.2);
            border: 1px solid rgba(97, 175, 239, 0.5);
        }
        .icon-img { font-size: 36px; margin-bottom: 5px; pointer-events: none; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        .icon-label { font-size: 12px; text-align: center; line-height: 1.2; pointer-events: none; word-break: break-word; }

        /* --- WINDOW SYSTEM --- */
        .window {
            position: absolute;
            background-color: var(--window-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            box-shadow: var(--shadow-win);
            display: flex; flex-direction: column;
            min-width: 300px; min-height: 200px;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            overflow: hidden;
            animation: openWindow 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        @keyframes openWindow {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .window.active-window { border: 1px solid rgba(97, 175, 239, 0.4); }

        .title-bar {
            height: 36px; background-color: rgba(33, 37, 43, 0.95);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 12px; cursor: default; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .title-text { font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #dcdcdc; pointer-events: none;}
        .window-controls { display: flex; gap: 8px; }
        .win-btn {
            width: 12px; height: 12px; border-radius: 50%; border: none; cursor: pointer;
        }
        .btn-close { background: #ff5f56; } .btn-close:hover { background: #ff3b30; }
        .btn-min { background: #ffbd2e; }
        .btn-max { background: #27c93f; }

        .window-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; background: rgba(33,37,43,0.6); }

        /* --- TASKBAR --- */
        #taskbar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 45px;
            background-color: var(--taskbar-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; align-items: center; padding: 0 10px;
            z-index: 9000; border-top: 1px solid rgba(255,255,255,0.1);
        }
        #start-btn {
            padding: 6px 14px; background: rgba(255,255,255,0.1); border-radius: 4px;
            cursor: pointer; font-weight: bold; color: #fff; font-size: 14px;
            display: flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        #start-btn:hover, #start-btn.active { background: var(--primary-color); color: #282c34; }
        
        .task-list { flex: 1; display: flex; align-items: center; margin-left: 15px; gap: 5px; overflow-x: auto; }
        .task-item {
            padding: 0 15px; height: 32px; max-width: 150px;
            background: rgba(255,255,255,0.05); border-radius: 4px;
            display: flex; align-items: center; cursor: pointer; color: #ccc;
            font-size: 12px; transition: 0.2s; white-space: nowrap; overflow: hidden;
        }
        .task-item:hover { background: rgba(255,255,255,0.1); }
        .task-item.active { background: rgba(255,255,255,0.15); border-bottom: 2px solid var(--primary-color); color: #fff; }

        .tray { margin-left: auto; display: flex; align-items: center; gap: 15px; font-size: 12px; color: #fff; padding-right: 10px; }

        /* --- START MENU --- */
        #start-menu {
            position: fixed; bottom: 55px; left: 10px; width: 320px; height: 480px;
            background: rgba(33, 37, 43, 0.98); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 9001;
            display: none; flex-direction: column;
            animation: slideUp 0.15s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .start-header { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 40px; height: 40px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #282c34; }
        .start-body { flex: 1; padding: 10px; overflow-y: auto; }
        .start-item { padding: 10px; cursor: pointer; border-radius: 5px; display: flex; align-items: center; gap: 12px; color: #eee; transition: 0.2s; }
        .start-item:hover { background: rgba(255,255,255,0.1); }
        .start-footer { padding: 10px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: flex-end; }
        .power-btn { background: transparent; border: 1px solid var(--danger-color); color: var(--danger-color); padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .power-btn:hover { background: var(--danger-color); color: white; }

        /* --- CONTEXT MENU --- */
        #context-menu {
            position: absolute; width: 180px; background: #2c313a; border: 1px solid #181a1f;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5); display: none; z-index: 10000; padding: 5px 0; border-radius: 4px;
        }
        .ctx-item { padding: 8px 15px; cursor: pointer; font-size: 13px; color: #eee; display: flex; justify-content: space-between; }
        .ctx-item:hover { background: var(--primary-color); color: #282c34; }
        .ctx-divider { height: 1px; background: #4b5263; margin: 4px 0; }

        /* --- APP SPECIFIC STYLES --- */
        /* Explorer */
        .explorer-layout { display: flex; flex-direction: column; height: 100%; color: #fff; }
        .explorer-toolbar { padding: 8px; background: rgba(0,0,0,0.2); display: flex; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .explorer-main { flex: 1; padding: 10px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; align-content: start; }
        .file-item { display: flex; flex-direction: column; align-items: center; padding: 10px; cursor: pointer; border-radius: 4px; border: 1px solid transparent; }
        .file-item:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        .file-icon { font-size: 32px; margin-bottom: 5px; }
        .file-name { font-size: 11px; text-align: center; word-break: break-all; }
        
        /* Editor */
        .editor-area { width: 100%; height: 100%; background: #1e1e1e; color: #d4d4d4; border: none; resize: none; padding: 10px; font-family: var(--font-code); font-size: 14px; line-height: 1.5; }
        .editor-toolbar { padding: 5px 10px; background: #252526; display: flex; gap: 10px; align-items: center; }
        .editor-input { background: #3c3c3c; border: 1px solid #555; color: white; padding: 2px 5px; border-radius: 3px; font-family: var(--font-code); flex: 1; }
        
        /* Browser */
        .browser-layout { display: flex; flex-direction: column; height: 100%; background: #fff; }
        .browser-bar { padding: 8px; background: #f0f0f0; display: flex; gap: 5px; border-bottom: 1px solid #ccc; }
        .browser-url { flex: 1; border-radius: 20px; border: 1px solid #ccc; padding: 5px 15px; outline: none; font-size: 13px; }
        .browser-frame { flex: 1; border: none; background: #fff; width: 100%; height: 100%; }

        /* Camera & Video */
        .camera-container { width: 100%; height: 100%; background: #000; position: relative; display: flex; flex-direction: column; }
        video { width: 100%; flex: 1; object-fit: contain; }
        .camera-controls { padding: 15px; display: flex; justify-content: center; gap: 20px; background: rgba(0,0,0,0.8); }
        .cam-btn { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #fff; background: transparent; cursor: pointer; }
        .cam-btn.record { background: #ff0000; border-color: #ff0000; }
        .cam-btn.photo { background: #fff; }

        /* Paint */
        .paint-layout { display: flex; flex-direction: column; height: 100%; background: #ccc; }
        .paint-tools { padding: 5px; background: #f0f0f0; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #999; }
        .paint-canvas { background: #fff; cursor: crosshair; display: block; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.2); }

        /* Terminal */
        .terminal-bg { background: #0c0c0c; color: #cccccc; font-family: 'Consolas', monospace; padding: 10px; height: 100%; overflow-y: auto; font-size: 14px; }
        .term-line { margin-bottom: 2px; }
        .term-prompt { color: #98c379; margin-right: 5px; }

        /* Gallery */
        .gallery-layout { display: flex; flex-direction: column; height: 100%; padding: 10px; overflow-y: auto; }
        .gallery-section { margin-bottom: 20px; }
        .gallery-header { font-weight: bold; color: var(--primary-color); border-bottom: 1px solid #444; margin-bottom: 10px; padding-bottom: 5px; }

        /* --- UTILS --- */
        .btn-ui { padding: 5px 10px; background: var(--primary-color); border: none; border-radius: 4px; color: #282c34; cursor: pointer; font-weight: 600; font-size: 12px; }
        .btn-ui:hover { opacity: 0.9; }
        
        /* Toast Notification */
        #toast-container { position: fixed; bottom: 60px; right: 20px; z-index: 20000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #21252b; border-left: 4px solid var(--primary-color); padding: 15px; border-radius: 4px; color: #fff; width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

    </style>
</head>
<body oncontextmenu="return false;">

    <div id="boot-screen">
        <div style="font-size: 32px; font-weight: bold; letter-spacing: 2px;">DEV</div>
        <div style="margin-top: 5px; font-size: 12px; color: #666;">A arte do impossivel √© o sonho que nele nasce</div>
        <div class="loader-bar"><div class="loader-progress" id="boot-bar"></div></div>
        <div id="boot-status" style="margin-top: 15px; font-size: 12px; color: #888;">Inicializando Kernel...</div>
    </div>

    <div id="desktop">
        <div class="desktop-icons-container" id="icon-grid">
            </div>
    </div>

    <div id="start-menu">
        <div class="start-header">
            <div class="user-avatar">AD</div>
            <div>
                <div style="font-weight: bold; color: #fff;">Admin User</div>
                <div style="font-size: 11px; color: #aaa;">Dev</div>
            </div>
        </div>
        <div class="start-body" id="start-list">
            </div>
        <div class="start-footer">
            <button class="power-btn" onclick="location.reload()">‚èª Reiniciar Sistema</button>
        </div>
    </div>

    <div id="taskbar">
        <div id="start-btn" onclick="toggleStartMenu()">
            <span>‚ùñ</span>
        </div>
        <div class="task-list" id="task-list">
            </div>
        <div class="tray">
            <span id="network-status">üì∂</span>
            <span id="sound-status">üîä</span>
            <div style="text-align: right; line-height: 1.1;">
                <div id="clock-time" style="font-weight: bold;">00:00</div>
                <div id="clock-date" style="font-size: 10px; color: #aaa;">00/00/0000</div>
            </div>
        </div>
    </div>

    <div id="context-menu">
        <div class="ctx-item" onclick="createWindow('editor')">Novo Arquivo de Texto</div>
        <div class="ctx-item" onclick="createWindow('explorer')">Abrir Explorador</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item" onclick="refreshDesktop()">Atualizar</div>
        <div class="ctx-item" onclick="changeWallpaper()">trocar Papel de Parede</div>
    </div>

    <div id="toast-container"></div>

    <script>
        // --- SYSTEM CONFIGURATION & STATE ---
        const sysConfig = {
            apps: [
                { id: 'explorer', name: 'Arquivos', icon: 'üìÅ', type: 'explorer' },
                { id: 'browser', name: 'Navegador', icon: 'üåê', type: 'browser' },
                { id: 'camera', name: 'C√¢mera Pro', icon: 'üì∏', type: 'camera' },
                { id: 'gallery', name: 'Galeria', icon: 'üñºÔ∏è', type: 'gallery' },
                { id: 'recorder', name: 'Gravador', icon: 'üé§', type: 'recorder' },
                { id: 'paint', name: 'Paint', icon: 'üé®', type: 'paint' },
                { id: 'editor', name: 'Code Editor', icon: 'üìù', type: 'editor' },
                { id: 'terminal', name: 'Terminal', icon: 'üíª', type: 'terminal' },
                { id: 'settings', name: 'Ajustes', icon: '‚öôÔ∏è', type: 'settings' }
            ],
            wallpapers: [
                'https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072',
                'https://images.unsplash.com/photo-1477346611705-65d1883cee1e?q=80&w=2070',
                'https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=2070',
                "https://wallpapers.com/images/high/aesthetic-computer-4k-zdh4qu5bvkokfi56.webp",
               "https://wallpapers.com/images/high/aesthetic-computer-4k-tiykjap13144jghd.webp",
               "https://wallpapers.com/images/high/aesthetic-computer-4k-2o1einarkegqjjj5.webp",
              "https://wallpapers.com/images/high/aesthetic-computer-4k-lxt7iuha7vqd8tck.webp",
            "https://wallpapers.com/images/high/aesthetic-computer-4k-bn4syklw2p8qu3n5.webp",
            "https://wallpapers.com/images/high/rio-de-janeiro-praia-do-forte-d3di4c346dpslj8f.webp",
            "https://wallpapers.com/images/high/magical-night-sky-with-stars-glowing-on-forest-odhlf3pbxuyevoam.webp"
            ]
        };

        let fileSystem = JSON.parse(localStorage.getItem('devos_full_fs')) || [
    { 
        name: 'Bem-Vindo.txt', 
        content: '=====================================================\n    BEM-VINDO AO DEV\n=====================================================\n\nSauda√ß√µes, usu√°rio. \n\nVoc√™ acaba de inicializar o ambiente Dev, um sistema operacional simulado de alta performance.\n\n--- O QUE VOC√ä PODE FAZER AQUI? ---\n\n1. EXPLORADOR DE ARQUIVOS (üìÅ): Gerencie seus documentos e m√≠dias.\n2. C√ÇMERA PRO (üì∏): Capture fotos e v√≠deos reais.\n3. CODE EDITOR (üìù): Escreva e execute c√≥digos HTML em tempo real.\n4. TERMINAL (üíª): Comandos de sistema para controle avan√ßado.\n5. GRAVADOR (üé§): Grave √°udios e salve-os na galeria.\n6. PAINT (üé®): Ferramenta completa de desenho.\n\n--- DICAS R√ÅPIDAS ---\n- Use o bot√£o direito no desktop para trocar o papel de parede.\n- Seus arquivos ficam salvos no cache do navegador.\n\nExplore, crie e divirta-se!\n\nAtenciosamente,\nCuran cat.', 
        type: 'txt' 
    },
    { 
        name: 'Exemplo_Web.html', 
        content: '<div style="font-family:sans-serif; text-align:center; padding:20px; background:#1e1e1e; color:#61afef; border-radius:10px; border: 2px solid #61afef;">\n<h1>üöÄ Dev creat</h1>\n<p>Este √© um teste de execu√ß√£o</p>\n<button onclick="alert(\'Funciona!\')" style="padding:10px; cursor:pointer;">Teste</button>\n</div>', 
        type: 'html' 
    }
];

        let windows = {}; 
        let zIndexCounter = 100;
        let activeWindowId = null;
        let wallpaperIndex = 0;
        let mediaRecorder = null;
        let mediaChunks = [];
        let globalStream = null;

        // --- INITIALIZATION ---
        window.onload = function() {
            runBootSequence();
        };

        function runBootSequence() {
            let width = 0;
            const bar = document.getElementById('boot-bar');
            const status = document.getElementById('boot-status');
            
            const interval = setInterval(() => {
                width += Math.random() * 5;
                if(width > 100) width = 100;
                bar.style.width = width + '%';

                if(width > 30) status.innerText = "Carregando Drivers de M√≠dia...";
                if(width > 60) status.innerText = "Montando Sistema de Arquivos...";
                if(width > 90) status.innerText = "Iniciando Interface Gr√°fica...";

                if(width === 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('boot-screen').style.display = 'none';
                        initDesktop();
                    }, 500);
                }
            }, 100);
        }

        function initDesktop() {
            setupClock();
            renderIcons();
            renderStartMenu();
            
            // Global click to close menus
            document.addEventListener('click', (e) => {
                const startMenu = document.getElementById('start-menu');
                const startBtn = document.getElementById('start-btn');
                const ctxMenu = document.getElementById('context-menu');
                
                if(!startMenu.contains(e.target) && !startBtn.contains(e.target)) {
                    startMenu.style.display = 'none';
                    startBtn.classList.remove('active');
                }
                
                ctxMenu.style.display = 'none';
                
                // Deselect icons
                if(e.target.id === 'desktop') {
                    document.querySelectorAll('.icon').forEach(i => i.classList.remove('selected'));
                }
            });

            // Context Menu
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const ctx = document.getElementById('context-menu');
                ctx.style.display = 'block';
                ctx.style.left = e.clientX + 'px';
                ctx.style.top = e.clientY + 'px';
            });

            showToast('Sistema Pronto', 'Dev inicializado com sucesso.');
        }

        // --- CORE UI RENDERERS ---
        function renderIcons() {
            const container = document.getElementById('icon-grid');
            container.innerHTML = '';
            sysConfig.apps.forEach((app, i) => {
           const el = document.createElement('div');
                el.className = 'icon';
                el.style.top = (20 + i * 100) + 'px';
                el.style.left = '20px';
                el.innerHTML = `<div class="icon-img">${app.icon}</div><div class="icon-label">${app.name}</div>`;
                
                el.onclick = (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.icon').forEach(x => x.classList.remove('selected'));
                    el.classList.add('selected');
                };
                el.ondblclick = () => createWindow(app.id);
                el.onmousedown = (e) => initDrag(e, el);

                container.appendChild(el);
            });
        }

        function renderStartMenu() {
            const list = document.getElementById('start-list');
            sysConfig.apps.forEach(app => {
                const item = document.createElement('div');
                item.className = 'start-item';
                item.innerHTML = `<span>${app.icon}</span> ${app.name}`;
                item.onclick = () => {
                    createWindow(app.id);
                    document.getElementById('start-menu').style.display = 'none';
                };
                list.appendChild(item);
            });
        }

        function setupClock() {
            const update = () => {
                const now = new Date();
                document.getElementById('clock-time').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                document.getElementById('clock-date').innerText = now.toLocaleDateString();
            };
            setInterval(update, 1000);
            update();
        }

        function toggleStartMenu() {
            const menu = document.getElementById('start-menu');
            const btn = document.getElementById('start-btn');
            const isOpen = menu.style.display === 'flex';
            menu.style.display = isOpen ? 'none' : 'flex';
            if(!isOpen) btn.classList.add('active'); else btn.classList.remove('active');
        }

        // --- WINDOW MANAGEMENT ---
        function createWindow(appId, fileData = null) {
            const app = sysConfig.apps.find(a => a.id === appId) || {name: 'Visualizador', icon: 'üìÑ', type: 'viewer'};
            const id = 'win_' + Date.now();
            
            // Random position offset
            const x = 100 + (Math.random() * 50);
            const y = 50 + (Math.random() * 50);

            const win = document.createElement('div');
            win.className = 'window active-window';
            win.id = id;
            win.style.left = x + 'px';
            win.style.top = y + 'px';
            win.style.width = '800px';
            win.style.height = '500px';
            win.style.zIndex = ++zIndexCounter;

            win.innerHTML = `
                <div class="title-bar" onmousedown="initDrag(event, document.getElementById('${id}'))">
                    <div class="title-text">${app.icon} ${fileData ? fileData.name : app.name}</div>
                    <div class="window-controls">
                        <button class="win-btn btn-min" onclick="minimizeWindow('${id}')"></button>
                        <button class="win-btn btn-max" onclick="maximizeWindow('${id}')"></button>
                        <button class="win-btn btn-close" onclick="closeWindow('${id}')"></button>
                    </div>
                </div>
                <div class="window-content">${getAppContent(app.type, id, fileData)}</div>
            `;
            
            // Activate on click
            win.addEventListener('mousedown', () => activateWindow(id));

            document.getElementById('desktop').appendChild(win);
            
            // Register window
            windows[id] = { element: win, minimized: false, maximized: false, prevRect: null };
            addTaskbarItem(id, app.name, app.icon);
            activateWindow(id);

            // Post-render init (for canvases, video streams)
            initAppLogic(app.type, id, fileData);
        }

        function closeWindow(id) {
            const win = document.getElementById(id);
            if(win) {
                // Stop camera if closing camera app
                const vid = win.querySelector('video');
                if(vid && vid.srcObject) {
                    vid.srcObject.getTracks().forEach(track => track.stop());
                }
                win.remove();
            }
            delete windows[id];
            document.getElementById('task_' + id).remove();
        }

        function minimizeWindow(id) {
            const win = document.getElementById(id);
            win.style.display = 'none';
            windows[id].minimized = true;
            document.getElementById('task_'+id).classList.remove('active');
        }

        function maximizeWindow(id) {
            const win = document.getElementById(id);
            const state = windows[id];
            if(state.maximized) {
                win.style.width = state.prevRect.width;
                win.style.height = state.prevRect.height;
                win.style.top = state.prevRect.top;
                win.style.left = state.prevRect.left;
                state.maximized = false;
            } else {
                state.prevRect = { width: win.style.width, height: win.style.height, top: win.style.top, left: win.style.left };
                win.style.top = '0'; win.style.left = '0'; win.style.width = '100%'; win.style.height = 'calc(100vh - 45px)';
                state.maximized = true;
            }
        }

        function activateWindow(id) {
            if(activeWindowId && document.getElementById(activeWindowId)) {
                document.getElementById(activeWindowId).classList.remove('active-window');
                const task = document.getElementById('task_'+activeWindowId);
                if(task) task.classList.remove('active');
            }
            
            const win = document.getElementById(id);
            if(windows[id].minimized) {
                win.style.display = 'flex';
                windows[id].minimized = false;
            }
            
            win.style.zIndex = ++zIndexCounter;
            win.classList.add('active-window');
            document.getElementById('task_'+id).classList.add('active');
            activeWindowId = id;
        }

        function addTaskbarItem(id, name, icon) {
            const item = document.createElement('div');
            item.className = 'task-item active';
            item.id = 'task_' + id;
            item.innerHTML = `${icon} ${name}`;
            item.onclick = () => {
                if(activeWindowId === id && !windows[id].minimized) minimizeWindow(id);
                else activateWindow(id);
            };
            document.getElementById('task-list').appendChild(item);
        }

        // --- APP CONTENT GENERATORS ---
        function getAppContent(type, id, fileData) {
            switch(type) {
                case 'explorer':
                    return `
                        <div class="explorer-layout">
                            <div class="explorer-toolbar">
                                <button class="btn-ui" onclick="createWindow('editor')">+ Novo Arquivo</button>
                                <button class="btn-ui" onclick="refreshExplorer('${id}')">‚Üª Recarregar</button>
                            </div>
                            <div class="explorer-main" id="exp_main_${id}"></div>
                        </div>`;
                case 'editor':
                    const content = fileData ? fileData.content : '';
                    const name = fileData ? fileData.name : 'novo_arquivo.txt';
                    return `
                        <div style="display:flex; flex-direction:column; height:100%;">
                            <div class="editor-toolbar">
                                <input id="ed_name_${id}" class="editor-input" value="${name}">
                                <button class="btn-ui" onclick="saveFile('${id}')">Salvar</button>
                                <button class="btn-ui" onclick="runCode('${id}')">Executar</button>
                            </div>
                            <textarea id="ed_area_${id}" class="editor-area" spellcheck="false">${content}</textarea>
                        </div>`;
                case 'browser':
    return `
        <div class="browser-layout">
            <div class="browser-bar">
                <input class="browser-url" id="url_${id}" placeholder="Pesquise ou digite URL..." onkeydown="if(event.key=='Enter') loadURL('${id}')">
                <button class="btn-ui" onclick="loadURL('${id}')">Ir</button>
            </div>
            <iframe id="frame_${id}" class="browser-frame" src="https://www.bing.com" 
                sandbox="allow-forms allow-scripts allow-same-origin allow-presentation">
            </iframe>
        </div>`;
                case 'camera':
                    return `
                        <div class="camera-container">
                            <video id="vid_${id}" autoplay></video>
                            <div class="camera-controls">
                                <button class="cam-btn photo" onclick="takePhoto('${id}')" title="Tirar Foto"></button>
                                <button class="cam-btn record" id="rec_btn_${id}" onclick="toggleRecord('${id}')" title="Gravar V√≠deo"></button>
                            </div>
                        </div>`;
                case 'paint':
                    return `
                        <div class="paint-layout">
                            <div class="paint-tools">
                                <label>Cor:</label><input type="color" id="p_color_${id}">
                                <label>Tamanho:</label><input type="range" id="p_size_${id}" min="1" max="50" value="5">
                                <button class="btn-ui" onclick="clearPaint('${id}')">Limpar</button>
                            </div>
                            <div style="flex:1; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#ccc;">
                                <canvas id="canvas_${id}" width="800" height="600" class="paint-canvas"></canvas>
                            </div>
                        </div>`;
                case 'gallery':
                    return `
                        <div class="gallery-layout">
                            <div class="gallery-section">
                                <div class="gallery-header">üì∏ Fotos</div>
                                <div class="explorer-main" id="gal_photos_${id}" style="height:auto; min-height:100px;"></div>
                            </div>
                            <div class="gallery-section">
                                <div class="gallery-header">üé¨ V√≠deos</div>
                                <div class="explorer-main" id="gal_videos_${id}" style="height:auto; min-height:100px;"></div>
                            </div>
                            <div class="gallery-section">
                                <div class="gallery-header">üéµ √Åudios</div>
                                <div class="explorer-main" id="gal_audios_${id}" style="height:auto; min-height:100px;"></div>
                            </div>
                        </div>`;
                case 'viewer':
                    if(!fileData) return '<div style="padding:20px">Nenhum arquivo.</div>';
                    const ext = fileData.name.split('.').pop().toLowerCase();
                    if(['jpg','png','jpeg'].includes(ext)) 
                        return `<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#000;"><img src="${fileData.content}" style="max-width:100%;max-height:100%;"></div>`;
                    if(ext === 'webm') 
                        return `<video src="${fileData.content}" controls style="width:100%;height:100%;background:#000;"></video>`;
                    if(ext === 'wav') 
                        return `<div style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;"><div style="font-size:50px;">üéµ</div><h3>${fileData.name}</h3><audio src="${fileData.content}" controls></audio></div>`;
                    return `<iframe srcdoc="${fileData.content.replace(/"/g, '&quot;')}" style="width:100%;height:100%;border:none;background:#fff;"></iframe>`;
                case 'recorder':
                    return `
                        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:20px;">
                            <div style="font-size:60px;">üéôÔ∏è</div>
                            <div id="rec_status_${id}">Pronto para gravar</div>
                            <button id="audio_rec_btn_${id}" class="btn-ui" style="padding:10px 20px; font-size:16px;" onclick="toggleAudioRecord('${id}')">Iniciar Grava√ß√£o</button>
                        </div>`;
                case 'terminal':
                    return `
                        <div class="terminal-bg" id="term_out_${id}">
                            <div>DevOS Terminal [Version 1.0]</div>
                            <div>(c) Dev Corporation. All rights reserved.</div><br>
                            <div class="term-line" style="display:flex;"><span class="term-prompt">root@devos:~$</span><input class="term-in" id="term_in_${id}" onkeydown="handleTerminal(event, '${id}')"></div>
                        </div>`;
                case 'settings':
                    return `
                        <div style="padding:20px; color:#fff;">
                            <h3>Configura√ß√µes</h3>
                            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:5px; margin-bottom:10px;">
                                <label>Brilho da Tela</label>
                                <input type="range" min="30" max="100" value="100" style="width:100%" oninput="document.body.style.filter = 'brightness('+this.value+'%)'">
                            </div>
                             <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:5px;">
                                <button class="btn-ui" style="background:#e06c75; color:white; width:100%;" onclick="localStorage.clear(); location.reload();">Resetar Sistema de F√°brica</button>
                            </div>
                        </div>`;
                default: return '<div>App n√£o suportado.</div>';
            }
        }

        // --- APP LOGIC INITIALIZERS ---
        function initAppLogic(type, id, fileData) {
            if(type === 'explorer') refreshExplorer(id);
            if(type === 'gallery') refreshGallery(id);
            if(type === 'paint') initPaintCanvas(id);
            if(type === 'camera') initCamera(id);
            if(type === 'terminal') document.getElementById(`term_in_${id}`).focus();
        }

        // --- FILE SYSTEM FUNCTIONS ---
        function refreshExplorer(id) {
            const container = document.getElementById(`exp_main_${id}`);
            if(!container) return;
            container.innerHTML = '';
            
            fileSystem.forEach((file, index) => {
                const el = document.createElement('div');
                el.className = 'file-item';
                
                let icon = 'üìÑ';
                if(file.name.endsWith('.html')) icon = 'üåê';
                if(file.name.endsWith('.jpg')) icon = 'üñºÔ∏è';
                if(file.name.endsWith('.webm')) icon = 'üé¨';
                if(file.name.endsWith('.wav')) icon = 'üéµ';

                el.innerHTML = `<div class="file-icon">${icon}</div><div class="file-name">${file.name}</div>`;
                el.ondblclick = () => openFile(file);
                el.oncontextmenu = (e) => {
                    e.preventDefault();
                    if(confirm(`Excluir ${file.name}?`)) {
                        fileSystem.splice(index, 1);
                        saveFileSystem();
                        refreshExplorer(id);
                    }
                };
                container.appendChild(el);
            });
        }

        function refreshGallery(id) {
            const photos = document.getElementById(`gal_photos_${id}`);
            const videos = document.getElementById(`gal_videos_${id}`);
            const audios = document.getElementById(`gal_audios_${id}`);
            if(!photos) return;

            [photos, videos, audios].forEach(el => el.innerHTML = '');

            fileSystem.forEach(file => {
                let target = null;
                let icon = '';
                if(file.name.endsWith('.jpg')) { target = photos; icon = 'üñºÔ∏è'; }
                else if(file.name.endsWith('.webm')) { target = videos; icon = 'üé¨'; }
                else if(file.name.endsWith('.wav')) { target = audios; icon = 'üéµ'; }

                if(target) {
                    const el = document.createElement('div');
                    el.className = 'file-item';
                    el.innerHTML = `<div class="file-icon">${icon}</div><div class="file-name">${file.name}</div>`;
                    el.ondblclick = () => openFile(file);
                    target.appendChild(el);
                }
            });
        }

        function openFile(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if(['txt', 'html'].includes(ext)) createWindow('editor', file);
            else createWindow('viewer', file);
        }

        function saveFile(id) {
            const name = document.getElementById(`ed_name_${id}`).value;
            const content = document.getElementById(`ed_area_${id}`).value;
            
            const existing = fileSystem.find(f => f.name === name);
            if(existing) {
                existing.content = content;
            } else {
                fileSystem.push({
                    name: name,
                    content: content,
                    type: name.split('.').pop()
                });
            }
            saveFileSystem();
            showToast('Arquivo Salvo', name + ' foi salvo com sucesso.');
        }

        function runCode(id) {
            const content = document.getElementById(`ed_area_${id}`).value;
            createWindow('viewer', { name: 'Preview', content: content });
        }

        function saveFileSystem() {
            localStorage.setItem('devos_full_fs', JSON.stringify(fileSystem));
            // Refresh all open explorers
            Object.keys(windows).forEach(winId => refreshExplorer(winId));
        }

        // --- BROWSER LOGIC ---
        function loadURL(id) {
            const urlInput = document.getElementById(`url_${id}`).value;
            const frame = document.getElementById(`frame_${id}`);
            let url = urlInput;
            
            if(!url.startsWith('http')) {
                if(url.includes('.')) url = 'https://' + url;
                else url = 'https://www.bing.com/search?q=' + url;
            }
            frame.src = url;
        }

        // --- CAMERA & VIDEO LOGIC ---
        function initCamera(id) {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    const vid = document.getElementById(`vid_${id}`);
                    if(vid) vid.srcObject = stream;
                    globalStream = stream; // Keep ref for recording
                })
                .catch(err => {
                    document.getElementById(`vid_${id}`).parentElement.innerHTML = '<div style="color:white;text-align:center;padding-top:50px;">Erro: C√¢mera n√£o encontrada ou permiss√£o negada.</div>';
                });
        }

        function takePhoto(id) {
            const vid = document.getElementById(`vid_${id}`);
            const canvas = document.createElement('canvas');
            canvas.width = vid.videoWidth;
            canvas.height = vid.videoHeight;
            canvas.getContext('2d').drawImage(vid, 0, 0);
            
            const dataUrl = canvas.toDataURL('image/jpeg');
            const fileName = `Foto_${Date.now()}.jpg`;
            
            fileSystem.push({ name: fileName, content: dataUrl, type: 'jpg' });
            saveFileSystem();
            showToast('Foto Capturada', 'Salva na Galeria como ' + fileName);
        }

        function toggleRecord(id) {
            const btn = document.getElementById(`rec_btn_${id}`);
            
            if(mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                btn.style.backgroundColor = 'transparent';
                btn.style.borderColor = '#fff';
            } else {
                if(!globalStream) return;
                mediaChunks = [];
                mediaRecorder = new MediaRecorder(globalStream);
                mediaRecorder.ondataavailable = e => mediaChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(mediaChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const fileName = `Video_${Date.now()}.webm`;
                    fileSystem.push({ name: fileName, content: url, type: 'webm' });
                    saveFileSystem();
                    showToast('V√≠deo Salvo', fileName + ' adicionado.');
                };
                mediaRecorder.start();
                btn.style.backgroundColor = 'red';
                btn.style.borderColor = 'red';
            }
        }

        // --- AUDIO RECORDER LOGIC ---
        function toggleAudioRecord(id) {
            const btn = document.getElementById(`audio_rec_btn_${id}`);
            const status = document.getElementById(`rec_status_${id}`);
            
            if(mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                btn.innerText = "Iniciar Grava√ß√£o";
                status.innerText = "Grava√ß√£o Finalizada";
                btn.style.background = getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
            } else {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    mediaChunks = [];
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = e => mediaChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(mediaChunks, { type: 'audio/wav' });
                        const url = URL.createObjectURL(blob);
                        const fileName = `Audio_${Date.now()}.wav`;
                        fileSystem.push({ name: fileName, content: url, type: 'wav' });
                        saveFileSystem();
                        showToast('√Åudio Salvo', fileName + ' adicionado.');
                    };
                    mediaRecorder.start();
                    btn.innerText = "Parar Grava√ß√£o";
                    btn.style.background = "#ff5f56";
                    status.innerText = "Gravando...";
                });
            }
        }

        // --- PAINT LOGIC ---
        function initPaintCanvas(id) {
            const canvas = document.getElementById(`canvas_${id}`);
            const ctx = canvas.getContext('2d');
            let painting = false;

            // Set white background initially
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const start = () => painting = true;
            const end = () => { painting = false; ctx.beginPath(); };
            const draw = (e) => {
                if(!painting) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.lineWidth = document.getElementById(`p_size_${id}`).value;
                ctx.strokeStyle = document.getElementById(`p_color_${id}`).value;
                ctx.lineCap = 'round';

                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            };

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('mousemove', draw);
        }

        function clearPaint(id) {
            const canvas = document.getElementById(`canvas_${id}`);
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // --- TERMINAL LOGIC ---
        function handleTerminal(e, id) {
            if(e.key === 'Enter') {
                const input = e.target;
                const cmd = input.value.trim();
                const out = document.getElementById(`term_out_${id}`);
                
                // Add old line
                const history = document.createElement('div');
                history.innerHTML = `<span class="term-prompt">root@devos:~$</span> ${cmd}`;
                out.insertBefore(history, input.parentElement);
                
                // Process command
                let response = '';
                const parts = cmd.split(' ');
                
                switch(parts[0].toLowerCase()) {
                    case 'help': response = 'Comandos: help, ls, clear, date, whoami, reboot, exit'; break;
                    case 'ls': response = fileSystem.map(f => f.name).join('<br>'); break;
                    case 'date': response = new Date().toString(); break;
                    case 'whoami': response = 'root (Admin)'; break;
                    case 'clear': 
                        out.innerHTML = `<div>DevOS Terminal [Version 1.0]</div><br><div class="term-line" style="display:flex;"><span class="term-prompt">root@devos:~$</span><input class="term-in" id="term_in_${id}" onkeydown="handleTerminal(event, '${id}')"></div>`;
                        setTimeout(() => document.getElementById(`term_in_${id}`).focus(), 10);
                        return; // Exit function to avoid double input
                    case 'reboot': location.reload(); break;
                    case 'exit': closeWindow(id); return;
                    case '': break;
                    default: response = `Comando n√£o encontrado: ${parts[0]}`;
                }
                
                if(response) {
                    const respEl = document.createElement('div');
                    respEl.innerHTML = response;
                    respEl.style.marginBottom = '10px';
                    out.insertBefore(respEl, input.parentElement);
                }
                
                input.value = '';
                out.scrollTop = out.scrollHeight;
            }
        }

        // --- UTILS: DRAG & DROP ---
        function initDrag(e, el) {
            // Se for janela maximizada, n√£o arrastar
            if(el.classList.contains('window') && windows[el.id] && windows[el.id].maximized) return;

            let startX = e.clientX;
            let startY = e.clientY;
            let startLeft = el.offsetLeft;
            let startTop = el.offsetTop;

            const move = (ev) => {
                const dx = ev.clientX - startX;
                const dy = ev.clientY - startY;
                el.style.left = (startLeft + dx) + 'px';
                el.style.top = (startTop + dy) + 'px';
            };

            const stop = () => {
                document.removeEventListener('mousemove', move);
                document.removeEventListener('mouseup', stop);
            };

            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', stop);
        }

        // --- UTILS: TOAST ---
        function showToast(title, msg) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            el.innerHTML = `<div style="font-weight:bold; margin-bottom:5px;">${title}</div><div style="font-size:12px; color:#ccc;">${msg}</div>`;
            container.appendChild(el);
            setTimeout(() => {
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 300);
            }, 4000);
        }

        function refreshDesktop() {
            renderIcons();
            showToast('Sistema', '√Årea de trabalho atualizada.');
        }

        function changeWallpaper() {
            wallpaperIndex = (wallpaperIndex + 1) % sysConfig.wallpapers.length;
            document.getElementById('desktop').style.backgroundImage = `url('${sysConfig.wallpapers[wallpaperIndex]}')`;
        }

    </script>
</body>
</html>